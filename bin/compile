#!/usr/bin/env bash

set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
VITE_DIR="$BUILD_DIR/public/vite"
CDN_HOST=$(cat "$ENV_DIR/CDN_HOST")
CDN_VITE_URL="https://$CDN_HOST/$SOURCE_VERSION/vite"
MANIFEST_POLL_INTERVAL=10
HEROKU_BRANCH=$(cat "$ENV_DIR/HEROKU_BRANCH")

echo "--------------------------------------------------"
echo "Commit SHA        : $SOURCE_VERSION"
echo "CDN host          : $CDN_HOST"
echo "CDN vite url      : $CDN_VITE_URL"
echo "Public vite dir   : $VITE_DIR"
echo "Heroku Branch     : $HEROKU_BRANCH"
echo "--------------------------------------------------"

# Webhook variables
HARNESS_WEBHOOK_BASE_URL=$(cat "$ENV_DIR/HARNESS_WEBHOOK_BASE_URL")
HARNESS_ACCOUNT_IDENTIFIER=$(cat "$ENV_DIR/HARNESS_ACCOUNT_IDENTIFIER")
HARNESS_ORG_IDENTIFIER=$(cat "$ENV_DIR/HARNESS_ORG_IDENTIFIER")
HARNESS_PROJECT_IDENTIFIER=$(cat "$ENV_DIR/HARNESS_PROJECT_IDENTIFIER")
HARNESS_PIPELINE_IDENTIFIER=$(cat "$ENV_DIR/HARNESS_PIPELINE_IDENTIFIER")
HARNESS_TRIGGER_IDENTIFIER=$(cat "$ENV_DIR/HARNESS_TRIGGER_IDENTIFIER")
HARNESS_WEBHOOK_PAYLOAD="{\"commitSha\": \"$SOURCE_VERSION\", \"branch\": \"$HEROKU_BRANCH\"}"

# Construct URL
WEBHOOK_URL="${HARNESS_WEBHOOK_BASE_URL}?accountIdentifier=${HARNESS_ACCOUNT_IDENTIFIER}&orgIdentifier=${HARNESS_ORG_IDENTIFIER}&projectIdentifier=${HARNESS_PROJECT_IDENTIFIER}&pipelineIdentifier=${HARNESS_PIPELINE_IDENTIFIER}&triggerIdentifier=${HARNESS_TRIGGER_IDENTIFIER}"

download_manifest_file() {
  local manifest_file_path=$VITE_DIR/$1/manifest.json
  local cdn_url=$CDN_VITE_URL/$1/manifest.json

  mkdir -p "$(dirname "$manifest_file_path")"

  curl -f -s -o "$manifest_file_path" "$cdn_url"
}

check_manifest_loop() {
  while true; do
    if download_manifest_file $1; then
      echo "Manifest file downloaded successfully."
      break
    else
      echo "Manifest file not found. Retrying in $MANIFEST_POLL_INTERVAL seconds..."
      sleep $MANIFEST_POLL_INTERVAL
    fi
  done
}

trigger_webhook() {
  curl -X POST \
    -H 'Content-Type: application/json' \
    --url "$WEBHOOK_URL" \
    -d "$HARNESS_WEBHOOK_PAYLOAD"
}

echo "Downloading manifest file..."
if download_manifest_file ".vite"; then
  echo "Manifest file previously built: downloaded successfully."
else
  echo "Manifest file unavailable. Triggering webhook..."
  trigger_webhook
  sleep $MANIFEST_POLL_INTERVAL
  check_manifest_loop ".vite"
fi

echo "Downloading manifest files for standalone apps in $VITE_DIR..."
for subdir in "$VITE_DIR"/*; do
  if [[ -d $subdir && $(basename "$subdir") != ".vite" ]]; then
    subdir_name=$(basename "$subdir")

    if download_manifest_file "$subdir_name/.vite"; then
      echo "Manifest file for $subdir_name downloaded successfully."
    else
      echo "Manifest file for $subdir_name unavailable. Retrying..."
      check_manifest_loop "$subdir_name/.vite"
    fi
  fi
done

# Inprogress:
# https://dashboard.heroku.com/apps/oyster-deplo-hackathon--cy8arx/activity/builds/b6f1000c-6b18-4940-a3c1-c318ad830262